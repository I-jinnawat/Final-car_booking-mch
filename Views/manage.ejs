<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จัดการ</title>
    <link rel="stylesheet" href="/css/booking.css">
    <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.1.0/uicons-bold-rounded/css/uicons-bold-rounded.css'>
    <link rel='stylesheet'
        href='https://cdn-uicons.flaticon.com/2.1.0/uicons-regular-rounded/css/uicons-regular-rounded.css'>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        .btn-check:checked+.btn {
            color: black;
            background-color: #d9d9d9;
            border-color: black;
        }

        .btn-outline-primary {
            color: #6c757d;
            border-color: #6c757d;
        }

        .btn-outline-primary:focus,
        .btn-outline-primary:hover {
            color: #6c757d;
            border-color: #6c757d;
        }

        .btn-check:checked+.btn-outline-primary {
            background-color: #d9d9d9;
            border-color: #6c757d;
        }

        .btn-outline-primary:hover {
            color: #6c757d !important;
            border-color: #6c757d !important;
        }
    </style>
</head>

<body>
    <%- include('components/navbar.ejs') -%>
        <div class="container-fluid mt-3 " id="main">
            <div class="row">
                <div class="col-12 ">
                    <div class="container-fluid p-0 m-0"
                        style="display: flex; justify-content: space-between;align-items: center;">
                        <button type="button" onclick="toggleNav()" class="toggler mb-2 p-0 m-0"
                            style="font-size: 20px">
                            <i class="fi fi-rr-indent" id="toggleIcon" style="color: white"></i>
                        </button>
                        <%- include('components/userinfo.ejs') -%>
                    </div>
                    <div class="card" style="box-shadow: 0px 8px 24px 0px rgba(0, 0, 0, 0.25)">
                        <div class="card-body">
                            <div id="status-control">
                                <div id="status-control">
                                    <label for="">สิทธิ์ :</label>
                                    <div class="btn-group" role="group">
                                        <input type="radio" class="btn-check" name="btnradio" autocomplete="off"
                                            readonly <%=user.role==="user" ? "checked" : "" %>>
                                        <label class="btn btn-outline-primary" for="btnradio1">พนักงาน</label>

                                        <input type="radio" class="btn-check" name="btnradio" autocomplete="off"
                                            readonly <%=user.role==="admin" ? "checked" : "" %>>
                                        <label class="btn btn-outline-primary" for="btnradio2">ผู้จัดรถ</label>

                                        <input type="radio" class="btn-check" name="btnradio" autocomplete="off"
                                            readonly <%=user.role==="approver" ? "checked" : "" %>>
                                        <label class="btn btn-outline-primary" for="btnradio3">ผู้อนุมัติ</label>
                                    </div>
                                    <span class="ms-3">
                                        <label for="">สถานะ</label>
                                        <div class="btn-group">
                                            <select class="form-select">
                                                <option selected>กำลังดำเนินการ...</option>
                                                <option value="1">ทั้งหมด</option>
                                                <option value="3">เสร็จสิ้น</option>
                                            </select>
                                        </div>
                                    </span>
                                </div>
                                <hr>
                                <div class="row mt-2">
                                    <div class="col d-flex justify-content-between" id="search">
                                        <div>
                                            <label for="">เมนู :</label>
                                            <a href="/booking" class="btn border-0 bookingbtn"
                                                style="background-color:#FFECB3; width: 100px;"><i
                                                    class="fa-regular fa-pen-to-square"></i>
                                                จองรถ</a>
                                        </div>
                                        <div class="search">
                                            <input class="p-1" type="text" placeholder="&#xf002; ค้นหา"
                                                style="width: 200px; border-radius: 8px ; border:1px solid black;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card mt-3" style="box-shadow: 0px 8px 24px 0px rgba(0, 0, 0, 0.25);">
                    <table class="table table-striped table-hover table-bordered">
                        <thead>
                            <tr>
                                <th scope="col">จัดการ</th>
                                <th scope="col">สถานะ</th>
                                <th scope="col">วันที่ร้องขอ</th>
                                <th scope="col">หัวข้อ</th>
                                <th scope="col">วันที่เริ่มเดินทาง</th>
                                <th scope="col">รถที่ใช้</th>
                                <th scope="col">ผู้ร้องขอ </th>
                                <th scope="col">หัวหน้าหน่วย</th>
                                <th scope="col">คนจัดรถ</th>
                                <th scope="col">คนขับรถ</th>
                                <th scope="col">คนยกเลิก</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% bookings.forEach(booking=> { %>
                                <tr>
                                    <td>
                                        <% if (booking.status !==5 ) { %>
                                            <!-- if status not equal 4 will show  (status 1,2,3) -->
                                            <% if (booking.status !==4) { %>
                                                <!-- Role user can see this part-->
                                                <% if (user.role==='user' ) { %>
                                                    <!-- Role user can see only booking status 1  or booking status 3 -->
                                                    <% if (booking.status===1 || booking.status===3) { %>
                                                        <div class="btn-group btn-group" role="group"
                                                            style="width: 100px;">
                                                            <a class="btn btn-warning"
                                                                href="/booking-edit/<%= booking._id %>" role="button"><i
                                                                    class="fa-regular fa-pen-to-square"></i></a>
                                                            <!-- If booking status 3 can see delete button -->
                                                            <% if (booking.status !==3){ %>
                                                                <button type="button" class="btn btn-danger"
                                                                    onclick="displayAlert('<%= booking._id %>')"><i
                                                                        class="fa-solid fa-trash-can"></i></button>
                                                                <% } %>
                                                        </div>
                                                        <% } else if (user.role==="admin" ) { %>
                                                            <div class="btn-group btn-group" role="group"
                                                                style="width: 100px;">
                                                                <a class="btn btn-warning"
                                                                    href="/booking-edit/<%= booking._id %>"
                                                                    role="button"><i
                                                                        class="fa-regular fa-pen-to-square"></i></a>
                                                                <button type="button" class="btn btn-danger"
                                                                    onclick="displayAlert('<%= booking._id %>')"><i
                                                                        class="fa-solid fa-trash-can"></i></button>
                                                            </div>
                                                            <% } else { %>
                                                                <button type="button" class="btn btn-warning"
                                                                    style="width: 100px;">Waiting</button>
                                                                <% } %>
                                                                    <% } else if(user.role==="approver"
                                                                        &&booking.status==1) { %>
                                                                        <div class="btn-group btn-group" role="group"
                                                                            style="width: 120px;">
                                                                            <a class="btn btn-warning"
                                                                                href="/booking-edit/<%= booking._id %>"
                                                                                role="button"><i
                                                                                    class="fa-regular fa-pen-to-square"></i></a>
                                                                            <a class="btn btn-success" href=""
                                                                                role="button" data-bs-toggle="modal"
                                                                                data-bs-target="#exampleModal"
                                                                                data-bs-whatever=""><i
                                                                                    class="fa-solid fa-check"></i></a>
                                                                            <div class="modal fade" id="exampleModal"
                                                                                aria-hidden="true">
                                                                                <div class="modal-dialog">
                                                                                    <div class="modal-content">
                                                                                        <div class="modal-header">
                                                                                            <h5 class="modal-title"
                                                                                                id="exampleModalLabel">
                                                                                                แก้ไขรายละเอียดการจอง
                                                                                            </h5>
                                                                                            <button type="button"
                                                                                                class="btn-close"
                                                                                                data-bs-dismiss="modal"
                                                                                                aria-label="Close"></button>
                                                                                        </div>
                                                                                        <div class="modal-body">
                                                                                            <form
                                                                                                action="/events/<%= booking._id %>"
                                                                                                method="POST">
                                                                                                <input type="hidden"
                                                                                                    name="status"
                                                                                                    value="2">
                                                                                                <div class="mb-3 row">
                                                                                                    <label for="title"
                                                                                                        class="col-sm-3 col-form-label">หัวข้อ:</label>
                                                                                                    <div
                                                                                                        class="col-sm-9">
                                                                                                        <input
                                                                                                            type="text"
                                                                                                            class="form-control"
                                                                                                            id="title"
                                                                                                            name="title"
                                                                                                            value="<%= booking.title %>">
                                                                                                    </div>
                                                                                                </div>
                                                                                                <div class="mb-3 row">
                                                                                                    <label for="title"
                                                                                                        class="col-sm-3 col-form-label">ผู้ร้องขอ:</label>
                                                                                                    <div
                                                                                                        class="col-sm-9">
                                                                                                        <input
                                                                                                            type="text"
                                                                                                            class="form-control"
                                                                                                            id="title"
                                                                                                            name="title"
                                                                                                            value="<%= booking.userinfo %>"
                                                                                                            readonly>
                                                                                                    </div>
                                                                                                </div>
                                                                                                <!-- Other form fields -->
                                                                                                <div class="row">
                                                                                                    <div
                                                                                                        class="col-sm-12">
                                                                                                        <button
                                                                                                            type="button"
                                                                                                            class="btn btn-secondary"
                                                                                                            data-bs-dismiss="modal">ปิด</button>
                                                                                                        <button
                                                                                                            type="submit"
                                                                                                            class="btn btn-primary">บันทึกการเปลี่ยนแปลง</button>
                                                                                                    </div>
                                                                                                </div>
                                                                                            </form>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                            <button type="button" class="btn btn-danger"
                                                                                onclick="displayAlert('<%= booking._id %>')"><i
                                                                                    class="fa-solid fa-trash-can"></i></button>
                                                                        </div>
                                                                        <% } else if(user.role==="admin" &&
                                                                            (booking.status===2 ||
                                                                            booking.status===3)){%>
                                                                            <%if(booking.status===2){%>
                                                                                <div class="btn-group btn-group"
                                                                                    role="group" style="width: 100px;">
                                                                                    <a class="btn btn-warning"
                                                                                        href="/booking-edit/<%= booking._id %>"
                                                                                        role="button"><i
                                                                                            class="fa-regular fa-pen-to-square"></i></a>
                                                                                    <button type="button"
                                                                                        class="btn btn-danger"
                                                                                        onclick="displayAlert('<%= booking._id %>')"><i
                                                                                            class="fa-solid fa-trash-can"></i></button>
                                                                                </div>
                                                                                <%}else{%>
                                                                                    <button type="button"
                                                                                        class="btn btn-danger"
                                                                                        onclick="displayAlert('<%= booking._id %>')"
                                                                                        style="width: 100px;"><i
                                                                                            class="fa-solid fa-trash-can"></i></button>
                                                                                    <%}%>

                                                                                        <% } else { %>
                                                                                            <button type="button"
                                                                                                class="btn btn-warning"
                                                                                                style="width: 100px;">Waiting</button>
                                                                                            <% } %>
                                                                                                <% } else { %>
                                                                                                    <div class="btn-group btn-group"
                                                                                                        role="group"
                                                                                                        style="width: 120px;">
                                                                                                        <a class="btn btn-secondary"
                                                                                                            href=""
                                                                                                            role="button"><i
                                                                                                                class="fa-solid fa-print"></i></a>


                                                                                                        <button
                                                                                                            type="button"
                                                                                                            class="btn btn-danger"
                                                                                                            onclick="displayAlert(' <%=booking._id %>')"><i
                                                                                                                class="fa-solid fa-trash-can"></i></button>

                                                                                                    </div>
                                                                                                    <% } %>
                                                                                                        <%}else{%>
                                                                                                            <% if(user.role==="user"
                                                                                                                ){%>
                                                                                                                cancle
                                                                                                                <%}else{%>
                                                                                                                    <button
                                                                                                                        type="button"
                                                                                                                        class="btn btn-danger"
                                                                                                                        onclick="displayAlert('<%= booking._id %>')"
                                                                                                                        style="width: 100px;"><i
                                                                                                                            class="fa-solid fa-trash-can"></i></button>

                                                                                                                    <%}%>
                                                                                                                        <%}%>

                                    </td>
                                    <td>
                                        <% const statusText=booking.status===1 ? '1.ทำการจองเสร็จ รอหัวหน้าอนุมัติ' :
                                            booking.status===2 ? '2.หัวหน้างานอนุมัติเสร็จ รอคนจัดรถ' :
                                            booking.status===3 ? '3.จัดรถสำเร็จ,พร้อมใช้งาน' : booking.status===4
                                            ? '4.เสร็จสิ้น' : booking.status===5 ?'ถูกยกเลิก': '' ; %>
                                            <%= statusText %>
                                    </td>
                                    <td>
                                        <%= new Date(booking.createdAt).toLocaleDateString('th-TH') %>

                                    </td>
                                    <td>
                                        <% if(user.role!=='user' ){ %>
                                            <%= booking.title %>
                                                <% }else{ %>
                                                    ไม่บอกง้าบบ
                                                    <% } %>
                                    </td>
                                    <td>
                                        <%= new Date(booking.start).toLocaleDateString('th-TH') %>
                                    </td>
                                    <td>
                                        <%= booking.vehicle %>
                                    </td>
                                    <td>
                                        <%= booking.userinfo %>
                                    </td>
                                    <td>
                                        <%= booking.approverName %>
                                    </td>
                                    <td>
                                        <%= booking.adminName %>
                                    </td>
                                    <td>
                                        <%= booking.driver %>
                                    </td>
                                    <td>
                                        <%= booking.cancelerName%>
                                    </td>
                                </tr>
                                <% }) %>
                        </tbody>
                    </table>
                </div>

            </div>
            <script src="/JS/alertDelete_manage.js"></script>
            <script src="../JS/navbar.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
            <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
            <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
                integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV"
                crossorigin="anonymous"></script>
            <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
                integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
                crossorigin="anonymous"></script>
            <script>
                function deleteBooking(bookingId) {
                    fetch(`/events/${bookingId}`, {
                        method: 'DELETE',
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Failed to delete booking');
                            }
                            window.location.reload();
                        })
                        .catch(error => {
                            console.error('Error deleting booking:', error);
                        });
                }
            </script>
</body>

</html>